#include <Wire.h>
#include <RTClib.h>
 
RTC_DS3231 rtc;
 
// Pin‐definisjoner
const int BUTTON_PIN   = 2;  // S1
const int RED_LED_PIN  = 3;  // D3
const int GREEN_LED_PIN= 4;  // D2
 
// Debounce
const unsigned long DEBOUNCE_MS = 50;
int  lastButtonState    = LOW;
bool finished           = false;
unsigned long lastDebounceTime = 0;
 
// For én-gangs reset ved 03:00
int lastResetDay = -1;
 
void setup() {
  pinMode(BUTTON_PIN,    INPUT);       // ekstern pull-down i hardwaren
  pinMode(RED_LED_PIN,   OUTPUT);
  pinMode(GREEN_LED_PIN, OUTPUT);
 
  // Sett start-tilstand
  finished = false;
  digitalWrite(RED_LED_PIN,   HIGH);   // rødt lys ON
  digitalWrite(GREEN_LED_PIN, LOW);
 
  // Start RTC
  Wire.begin();
  if (!rtc.begin()) {
    // Hvis RTC ikke svarer
    while (1) { /* hang */ }
  }
  if (rtc.lostPower()) {
    // Om RTC har mistet strøm noen gang, sett tid manuelt her:
    // rtc.adjust(DateTime(F(__DATE__), F(__TIME__)));
  }
}
 
void loop() {
  DateTime now = rtc.now();
 
  // 1) Reset kl. 03:00 én gang per dag
  if (now.hour() == 3 && now.day() != lastResetDay) {
    lastResetDay = now.day();
    finished = false;
    digitalWrite(RED_LED_PIN,   HIGH);
    digitalWrite(GREEN_LED_PIN, LOW);
  }
 
  // 2) Les knapp med debounce
  int reading = digitalRead(BUTTON_PIN);
  if (reading != lastButtonState) {
    lastDebounceTime = millis();
  }
  if (millis() - lastDebounceTime > DEBOUNCE_MS) {
    if (reading == HIGH && !finished) {
      // Knappetrykk: aktivitet ferdig
      finished = true;
      digitalWrite(RED_LED_PIN,   LOW);
      digitalWrite(GREEN_LED_PIN, HIGH);
    }
  }
  lastButtonState = reading;
 
  // 3) Kort pause – unngå å blokkere lenge
  delay(10);
}
